# kql

A collection of my KQL queries

## **Detection rules (Microsoft Defender XDR)**
|Name|Description|MITRE ATT&CK|
|-|-|-|
|[Base encoded PowerShell command](./detection-rules/Base-encoded-PowerShell-command/query.kql)|Detect PowerShell processes ran with encoded parameters, which is often used as a defense evasion technique|T1059: Command and Scripting Interpreter </br> T1059.001: PowerShell </br> T1086: PowerShell|
|[Email forwarding to external domain (Classic)](./detection-rules/Email-forwarding-to-external-domain-\(Classic\)/query.kql)|Detects creation of mailbox rules that have ForwardTo, ForwardAsAttachmentTo, or RedirectTo set to an external, untrusted domain (in Outlook Classic). You specify trusted domains in the query.|T1114: Email Collection </br> T1114.003: Email Forwarding Rule|
|[Email forwarding to external domain](./detection-rules/Email-forwarding-to-external-domain/query.kql)|Detects creation of mailbox rules that have ForwardTo, ForwardAsAttachmentTo, or RedirectTo set to an external, untrusted domain (in Outlook, or Outlook Web Access). You specify trusted domains in the query.|T1114: Email Collection </br> T1114.003: Email Forwarding Rule|
|[Email sent via forwarding to external domain](./detection-rules/Email-sent-via-forwarding-to-external-domain/query.kql)|Detects email messages that were forwarded to an external domain. You specify trusted domains in the query.|T1114: Email Collection </br> T1114.003: Email Forwarding Rule|
|[Executable email content detected by ASR](./detection-rules/Executable-email-content-detected-by-ASR/query.kql)|Attack Surface Reduction rule for Microsoft Defender for Endpoint. Rule detects instances of email opened within the Microsoft Outlook application, or Outlook.com and other popular webmail providers from running executable file types. </br>[Documentation &rarr;](https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference#block-executable-content-from-email-client-and-webmail)|T1204: User Execution </br> T1204.002: Malicious File|
|[Obfuscated script detected by ASR](./detection-rules/Obfuscated-script-detected-by-ASR/query.kql)|Attack Surface Reduction rule for Microsoft Defender for Endpoint. Script obfuscation is a common technique that both malware authors and legitimate applications use to hide intellectual property or decrease script loading times.</br> [Documentation &rarr;](https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference#block-execution-of-potentially-obfuscated-scripts)|T1027: Obfuscated Files or Information </br> T1027.010: Command Obfuscation|
|[Ransomware detected by ASR](./detection-rules/Ransomware-detected-by-ASR/query.kql)|Attack Surface Reduction rule for Microsoft Defender for Endpoint. Detects when both client and/or cloud heuristics determine a file to resemble ransomware.</br>[Documentation &rarr;](https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference#use-advanced-protection-against-ransomware)|T1486: Data Encrypted for Impact|
|[Script downloaded an executable detected by ASR](./detection-rules/Script-downloaded-an-executable-detected-by-ASR/query.kql)|Attack Surface Reduction rule for Microsoft Defender for Endpoint. Rule detects scripts that launch potentially malicious downloaded content. </br>[Documentation &rarr;](https://learn.microsoft.com/en-us/defender-endpoint/attack-surface-reduction-rules-reference#block-javascript-or-vbscript-from-launching-downloaded-executable-content)|T1059: Command and Scripting Interpreter </br> T1059.005: Visual Basic </br> T1059.007: JavaScript|
|[Sign in blocked by Conditional Access policy](./detection-rules/Sign-in-blocked-by-Conditional-Access-policy/query.kql)|Detects failed Conditional Access actions for a specified rule ID has been detected. You set the RuleID in the query.|T1556.009: Conditional Access Policies|
|[Trusted domain blocked by Defender](./detection-rules/Trusted-domain-blocked-by-Defender/query.kql)|Checks for web filtering blocks to trusted domains. You specify trusted domains in the query.|T1071: Application Layer Protocol </br> T1071.001: Web Protocols|